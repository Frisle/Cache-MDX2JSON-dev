<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="MDX2JSON.Tests">
<Description>
Classes with support methods for testing MDX2JSON</Description>
<IncludeCode>MDX2JSON.MDX2JSON</IncludeCode>
<TimeCreated>63636,71862.541637</TimeCreated>

<Method name="ProjectLength">
<Description>
Count project length in loc
do ##class(MDX2JSON.Tests).ProjectLength()</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Mask:%String="MDX2JSON"</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	 Set rset = ##class(%ResultSet).%New("%DynamicQuery:SQL")
	 Do rset.Prepare("SELECT Name FROM %Dictionary.ClassDefinition WHERE Name [ '"_Mask_"'")
	 Do rset.Execute()
	 Set count=0

	 While (rset.Next()) {
	     Set class = rset.Data("Name")
	     Do ##class(%Compiler.UDL.TextServices).GetTextAsArray($Namespace,class,.raw)
		 Set lines = $O(raw($C(0)),-1)
		 W class , " " , lines,!
		 Set count = count + lines 
	 }
	 W "Total ",count
]]></Implementation>
</Method>

<Method name="MoveFoldersIntoMobile">
<Description><![CDATA[
Entry point to move dashboards into mobile folder<br>
Moves all DeepSee folders into Mobile folder (creates folder, if required)]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Namespace=$Namespace</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Set mobileid =..CreateMobileFolder(Namespace)
	Set ns =$namespace
	Zn Namespace
	&sql(UPDATE %DeepSee_UserLibrary.Folder SET folder=:mobileid WHERE folder is null AND name != 'Mobile')
	Zn ns
	Do ##class(MDX2JSON.Tests).MoveWidgetsDSIntoMobile(Namespace)
	Return SQLCODE
]]></Implementation>
</Method>

<Method name="CreateMobileFolder">
<Description><![CDATA[
Creates DeepSee folder Mobile in <b>Namespace</b><br>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Namespace=$Namespace</FormalSpec>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	Set ns =$namespace
	Zn Namespace
	&sql(SELECT ID into :ID FROM %DeepSee_UserLibrary.Folder WHERE folder is null AND name = 'Mobile')
	Zn ns
	Return:$ISVALIDNUM(ID) ID
	
	Set folder = ##class(%DeepSee.UserLibrary.Folder).%New()
	Set folder.name = "Mobile"
	W $System.Status.GetErrorText(folder.%Save())
	
	Return folder.%Id()
]]></Implementation>
</Method>

<Method name="MoveWidgetsDSIntoMobile">
<Description>
Moves widgets datasources into Mobile folder</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Namespace=$Namespace</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Set ns =$namespace
	Zn Namespace
		&sql(DECLARE sql1 CURSOR FOR
		SELECT ID INTO :ID FROM %DeepSee_Dashboard.Definition)

	&sql(OPEN sql1)
	&sql(FETCH sql1)
	While (SQLCODE = 0) {
		Set Dashboard = ##class(%DeepSee.Dashboard.Definition).%OpenId(ID,,.st)
		For i=1:1:Dashboard.widgets.Count() {
			Set pivot = Dashboard.widgets.GetAt(i).dataSource
			If ((##class(%DeepSee.UserLibrary.Utils).%FolderItemExists(pivot)=0) && (##class(%DeepSee.UserLibrary.Utils).%FolderItemExists("Mobile/"_pivot)=1))
			{
				Set Dashboard.widgets.GetAt(i).dataSource = "Mobile/"_pivot
			}
        }  
        Do Dashboard.%Save()
        Set Dashboard=""
		&sql(FETCH sql1)
	}
	&sql(CLOSE sql1)

	Zn ns
	Return $$$OK
]]></Implementation>
</Method>

<Method name="DynamicObjects">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	#define IsNewVersion $S($System.Version.GetMajor()>2015:"1",$System.Version.GetMajor()=2015:$S($System.Version.GetMinor()>=3:"1",1:"0"),1:"0")
	#define NewDynObj ##Expression($S($$$IsNewVersion=1:"##class(%Object).%New()",1:"##class(%ZEN.proxyObject).%New()"))
	#define NewDynObjList ##Expression($S($$$IsNewVersion=1:"##class(%Array).%New()",1:"##class(%ListOfObjects).%New()"))
	#define NewDynDTList ##Expression($S($$$IsNewVersion=1:"##class(%Array).%New()",1:"##class(%ListOfDataTypes).%New()"))
	//#define Insert(%element) ##Expression($S($$$IsNewVersion=1:%element,1:b))
	#define InsertWrap(%obj,%element) ##Expression(S($$$IsNewVersion=1:$$$InsertOther(%obj,%element),1:$$$InsertOther(%obj,%element)))
	#define isq(%element) ##Expression($S($d(%element)=1:1,1:0))
	#define InsertOther(%obj,%element) $S($$$IsNewVersion=1:"do %obj.$push(%element)",1:"do %obj.Insert(%element)")
	//#define CallClass(%element) ##Expression(##class(MDX2JSON.Tests).A(%element))
	#define q(%element) $S($d(%element)="""":"""",1:"")
	#define Insert(%obj,%element) ##Expression($S($$$IsNewVersion=1:"do %obj.$push(%element)",1:"do %obj.Insert(%element)"))

	 //$$$InsertNew(%element),1:$$$InsertOld(%element)))
	#define InsertNew(%element) $push(%element)
	#define InsertOld(%element) Insert(%element)
	#define DynObjToJSON(%obj) ##Expression($S($$$IsNewVersion=1:"do %obj.$toJSON()",1:"do %obj.%ToJSON()"))
	
	set obj = $$$NewDynObj
	set obj.prop = "val"
	$$$DynObjToJSON(obj)
	
	set dtList = $$$NewDynDTList
	//do objList.$push("a")
	//do objList.Insert("a")
	//do objList.$$$Insert("a")
	$$$Insert(dtList,a)
	//w $$$CallClass("a")
	//w $$$isq("a")
]]></Implementation>
</Method>

<Method name="A">
<ClassMethod>1</ClassMethod>
<FormalSpec>a</FormalSpec>
<Implementation><![CDATA[
	set ^test($h)=a
	return "ololo"
]]></Implementation>
</Method>
</Class>
</Export>
